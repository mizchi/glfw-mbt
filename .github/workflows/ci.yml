name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  native-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hustcer/setup-moonbit@v1
      - name: Install GLFW
        run: brew install glfw
      - name: Update MoonBit registry
        run: moon update
      - name: Format
        run: |
          moon fmt
          git diff --exit-code
      - name: Check
        run: moon check --target native

  native-linux:
    runs-on: ubuntu-latest
    env:
      MOON_CC: clang
    steps:
      - uses: actions/checkout@v4
      - uses: hustcer/setup-moonbit@v1
      - name: Install GLFW
        run: sudo apt-get update && sudo apt-get install -y libglfw3-dev xvfb
      - name: Update MoonBit registry
        run: moon update
      - name: Check
        run: moon check --target native
      - name: Build smoke test
        working-directory: examples/smoke_test
        run: moon build src --target native
      - name: Run smoke test (headless)
        working-directory: examples/smoke_test
        run: xvfb-run -a ./_build/native/debug/build/smoke_test.exe

  native-windows:
    runs-on: windows-latest
    env:
      MOON_CC: clang
      CPATH: C:\vcpkg\installed\x64-windows-static\include
    steps:
      - uses: actions/checkout@v4
      - uses: hustcer/setup-moonbit@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Install GLFW
        run: vcpkg install glfw3:x64-windows-static
      - name: Update MoonBit registry
        run: moon update
      - name: Check
        run: moon check --target native
      - name: Patch smoke test for Windows
        working-directory: examples/smoke_test
        shell: pwsh
        run: |
          @"
          import {
            "mizchi/glfw" @glfw,
          }

          options(
            "is-main": true,
            link: {
              "native": {
                "cc-flags": "-IC:/vcpkg/installed/x64-windows-static/include",
                "cc-link-flags": "-LC:/vcpkg/installed/x64-windows-static/lib -lglfw3 -lgdi32 -luser32 -lshell32",
              },
            },
            "supported-targets": [ "native" ],
          )
          "@ | Set-Content -Path src/moon.pkg
      - name: Verify GLFW library exists
        shell: pwsh
        run: |
          Get-ChildItem C:\vcpkg\installed\x64-windows-static\lib\*glfw* | ForEach-Object { $_.FullName }
          Get-ChildItem C:\vcpkg\installed\x64-windows-static\lib\*.lib | ForEach-Object { $_.FullName }
      - name: Create m.lib workaround
        shell: pwsh
        run: |
          # MoonBit adds -lm but Windows has no m.lib (math is in UCRT)
          "void __moonbit_m_stub(void){}" | Set-Content -Path m.c
          clang -c m.c -o m.obj
          llvm-lib /out:C:\vcpkg\installed\x64-windows-static\lib\m.lib m.obj /nologo
      - name: Build smoke test
        working-directory: examples/smoke_test
        run: moon build src --target native
      - name: Run smoke test
        working-directory: examples/smoke_test
        run: .\_build\native\debug\build\smoke_test.exe
