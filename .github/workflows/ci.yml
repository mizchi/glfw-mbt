name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  native-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hustcer/setup-moonbit@v1
      - name: Install GLFW
        run: brew install glfw
      - name: Update MoonBit registry
        run: moon update
      - name: Format
        run: |
          moon fmt
          git diff --exit-code
      - name: Check
        run: moon check --target native

  native-linux:
    runs-on: ubuntu-latest
    env:
      CC: clang
    steps:
      - uses: actions/checkout@v4
      - uses: hustcer/setup-moonbit@v1
      - name: Install GLFW
        run: sudo apt-get update && sudo apt-get install -y libglfw3-dev xvfb
      - name: Update MoonBit registry
        run: moon update
      - name: Check
        run: moon check --target native
      - name: Build smoke test
        working-directory: examples/smoke_test
        run: moon build src --target native
      - name: Run smoke test (headless)
        working-directory: examples/smoke_test
        run: xvfb-run -a ./_build/native/debug/build/smoke_test.exe
